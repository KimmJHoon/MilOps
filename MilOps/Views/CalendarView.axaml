<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MilOps.ViewModels"
             xmlns:controls="using:MilOps.Views.Controls"
             x:Class="MilOps.Views.CalendarView"
             x:DataType="vm:CalendarViewModel">

  <Grid Background="#0a0a0a">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>

    <!-- 월 네비게이션 - iOS 스타일 -->
    <Border Grid.Row="0" Background="#1c1c1e" Padding="12,16" CornerRadius="0,0,20,20">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="Auto"/>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>

        <Button Grid.Column="0" Command="{Binding PreviousMonthCommand}"
                Background="#2c2c2e" BorderThickness="0" Padding="12,8" CornerRadius="12">
          <TextBlock Text="&#xe5cb;" FontFamily="{StaticResource MaterialIcons}"
                     FontSize="24" Foreground="#00a872"/>
        </Button>

        <TextBlock Grid.Column="1" Text="{Binding CurrentMonthYear}"
                   FontSize="22" Foreground="#effdf6"
                   HorizontalAlignment="Center" VerticalAlignment="Center"/>

        <Button Grid.Column="2" Command="{Binding NextMonthCommand}"
                Background="#2c2c2e" BorderThickness="0" Padding="12,8" CornerRadius="12">
          <TextBlock Text="&#xe5cc;" FontFamily="{StaticResource MaterialIcons}"
                     FontSize="24" Foreground="#00a872"/>
        </Button>
      </Grid>
    </Border>

    <!-- 범례 영역 (최종관리자가 아닐 때만 표시) -->
    <StackPanel Grid.Row="1" Spacing="8" Margin="12,12,12,0"
                IsVisible="{Binding ShowLegend}">
      <!-- 범례 - 카드 스타일 -->
      <Border Background="#1c1c1e" Padding="16,12" CornerRadius="12">
        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="32">
          <StackPanel Orientation="Horizontal" Spacing="8">
            <Border Width="16" Height="16" CornerRadius="8" Background="#00a872"/>
            <TextBlock Text="확정" Foreground="#b0b0b0" FontSize="13" VerticalAlignment="Center"/>
          </StackPanel>
          <StackPanel Orientation="Horizontal" Spacing="8">
            <Border Width="16" Height="16" CornerRadius="8" Background="#deb887"/>
            <TextBlock Text="예약 (미확정)" Foreground="#b0b0b0" FontSize="13" VerticalAlignment="Center"/>
          </StackPanel>
        </StackPanel>
      </Border>
    </StackPanel>

    <!-- 요일 헤더 -->
    <Border Grid.Row="2" Background="Transparent" Padding="12,12,12,8">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <TextBlock Grid.Column="0" Text="일" Foreground="#ff6b6b" FontSize="14" HorizontalAlignment="Center"/>
        <TextBlock Grid.Column="1" Text="월" Foreground="#808080" FontSize="14" HorizontalAlignment="Center"/>
        <TextBlock Grid.Column="2" Text="화" Foreground="#808080" FontSize="14" HorizontalAlignment="Center"/>
        <TextBlock Grid.Column="3" Text="수" Foreground="#808080" FontSize="14" HorizontalAlignment="Center"/>
        <TextBlock Grid.Column="4" Text="목" Foreground="#808080" FontSize="14" HorizontalAlignment="Center"/>
        <TextBlock Grid.Column="5" Text="금" Foreground="#808080" FontSize="14" HorizontalAlignment="Center"/>
        <TextBlock Grid.Column="6" Text="토" Foreground="#6b9fff" FontSize="14" HorizontalAlignment="Center"/>
      </Grid>
    </Border>

    <!-- 날짜 그리드 - ItemsControl + UniformGrid 사용 (동적 바인딩) -->
    <Border Grid.Row="3" Margin="8,0,8,8" CornerRadius="16" ClipToBounds="True">
      <ItemsControl ItemsSource="{Binding Days}" Background="#1c1c1e">
        <ItemsControl.ItemsPanel>
          <ItemsPanelTemplate>
            <UniformGrid Rows="6" Columns="7"/>
          </ItemsPanelTemplate>
        </ItemsControl.ItemsPanel>
        <ItemsControl.ItemTemplate>
          <DataTemplate x:DataType="vm:CalendarDay">
            <Button Command="{Binding $parent[ItemsControl].((vm:CalendarViewModel)DataContext).SelectDayCommand}"
                    CommandParameter="{Binding}"
                    Background="Transparent" BorderThickness="0" Padding="0"
                    HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                    HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch">
              <Border BorderBrush="#2c2c2e" BorderThickness="0.5" Background="#1c1c1e" ClipToBounds="True">
                <Grid Margin="2">
                  <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                  </Grid.RowDefinitions>

                  <!-- 날짜 숫자 -->
                  <TextBlock Grid.Row="0" Text="{Binding DayText}" FontSize="12" Foreground="{Binding DayColor}"
                             HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,2,0,0"/>

                  <!-- 일정 점 표시 영역 -->
                  <Grid Grid.Row="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                        IsVisible="{Binding HasSchedules}" Margin="1">
                    <!-- 최종관리자: 시도/사단별 색상 뱃지 (예약 개수 표시) - WrapPanel로 자동 줄바꿈 -->
                    <ItemsControl ItemsSource="{Binding GroupBadges}" IsVisible="{Binding IsSuperAdmin}"
                                  HorizontalAlignment="Center" VerticalAlignment="Center">
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                          <WrapPanel Orientation="Horizontal" HorizontalAlignment="Center"/>
                        </ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>
                      <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="vm:GroupBadgeItem">
                          <Border MinWidth="14" Height="14" CornerRadius="7" Background="{Binding Color}"
                                  Padding="2,0" Margin="1">
                            <TextBlock Text="{Binding Count}" FontSize="9" Foreground="White"
                                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
                          </Border>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    <!-- 일반 사용자: 확정/예약 점 -->
                    <StackPanel Orientation="Horizontal" Spacing="4" IsVisible="{Binding !IsSuperAdmin}"
                                HorizontalAlignment="Center" VerticalAlignment="Center">
                      <Border Width="8" Height="8" CornerRadius="4" Background="#00a872"
                              IsVisible="{Binding HasConfirmedSchedule}"/>
                      <Border Width="8" Height="8" CornerRadius="4" Background="#deb887"
                              IsVisible="{Binding HasReservedSchedule}"/>
                    </StackPanel>
                  </Grid>
                </Grid>
              </Border>
            </Button>
          </DataTemplate>
        </ItemsControl.ItemTemplate>
      </ItemsControl>
    </Border>

    <!-- 로딩 오버레이 -->
    <controls:LoadingOverlay Grid.RowSpan="4" IsVisible="{Binding IsLoading}"/>

    <!-- 선택한 날짜의 일정 목록 패널 -->
    <Border Grid.RowSpan="4"
            Background="#E60a0a0a"
            IsVisible="{Binding HasSelectedDaySchedules}">
      <Border Background="#1c1c1e" CornerRadius="20" Margin="16" Padding="20"
              VerticalAlignment="Center" MaxHeight="600">
        <Grid RowDefinitions="Auto,Auto,*,Auto">
          <!-- 헤더 -->
          <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,12">
            <StackPanel Orientation="Horizontal" Spacing="10">
              <TextBlock Text="&#xe935;" FontFamily="{StaticResource MaterialIcons}"
                         FontSize="24" Foreground="#00a872" VerticalAlignment="Center"/>
              <TextBlock Text="{Binding SelectedDayTitle}" FontSize="18" Foreground="#effdf6"
                         VerticalAlignment="Center"/>
            </StackPanel>
            <Button Grid.Column="1" Command="{Binding CloseSelectedDaySchedulesCommand}"
                    Background="#2c2c2e" Padding="8" CornerRadius="10">
              <TextBlock Text="&#xe5cd;" FontFamily="{StaticResource MaterialIcons}"
                         FontSize="20" Foreground="#808080"/>
            </Button>
          </Grid>

          <!-- 최종관리자용 필터 (모달 내부) -->
          <Border Grid.Row="1" Background="#2c2c2e" CornerRadius="12" Padding="12,10" Margin="0,0,0,12"
                  IsVisible="{Binding ShowFilter}">
            <ScrollViewer HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Disabled">
              <Grid>
                <!-- 시도 필터 (행정안전부) -->
                <ItemsControl ItemsSource="{Binding RegionFilters}"
                              IsVisible="{Binding IsRegionFilter}">
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <StackPanel Orientation="Horizontal" Spacing="10"/>
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                  <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:RegionFilterItem">
                      <Button Command="{Binding $parent[ItemsControl].((vm:CalendarViewModel)DataContext).SelectRegionFilterCommand}"
                              CommandParameter="{Binding}"
                              Background="{Binding IsSelected, Converter={StaticResource BoolToFilterBgConverter}}"
                              BorderBrush="{Binding Color}"
                              BorderThickness="2"
                              CornerRadius="16"
                              Padding="14,8"
                              MinWidth="60"
                              MinHeight="36">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                          <Border Width="10" Height="10" CornerRadius="5" Background="{Binding Color}"
                                  IsVisible="{Binding IsSelected}"/>
                          <TextBlock Text="{Binding Name}" FontSize="13"
                                     Foreground="{Binding IsSelected, Converter={StaticResource BoolToFilterFgConverter}}"/>
                        </StackPanel>
                      </Button>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- 사단 필터 (육군본부) -->
                <ItemsControl ItemsSource="{Binding DivisionFilters}"
                              IsVisible="{Binding IsDivisionFilter}">
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <StackPanel Orientation="Horizontal" Spacing="10"/>
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                  <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:DivisionFilterItem">
                      <Button Command="{Binding $parent[ItemsControl].((vm:CalendarViewModel)DataContext).SelectDivisionFilterCommand}"
                              CommandParameter="{Binding}"
                              Background="{Binding IsSelected, Converter={StaticResource BoolToFilterBgConverter}}"
                              BorderBrush="{Binding Color}"
                              BorderThickness="2"
                              CornerRadius="16"
                              Padding="14,8"
                              MinWidth="60"
                              MinHeight="36">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                          <Border Width="10" Height="10" CornerRadius="5" Background="{Binding Color}"
                                  IsVisible="{Binding IsSelected}"/>
                          <TextBlock Text="{Binding Name}" FontSize="13"
                                     Foreground="{Binding IsSelected, Converter={StaticResource BoolToFilterFgConverter}}"/>
                        </StackPanel>
                      </Button>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- 군/구 필터 (지자체 도 중간관리자) -->
                <ItemsControl ItemsSource="{Binding DistrictFilters}"
                              IsVisible="{Binding IsDistrictFilter}">
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <StackPanel Orientation="Horizontal" Spacing="10"/>
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                  <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:DistrictFilterItem">
                      <Button Command="{Binding $parent[ItemsControl].((vm:CalendarViewModel)DataContext).SelectDistrictFilterCommand}"
                              CommandParameter="{Binding}"
                              Background="{Binding IsSelected, Converter={StaticResource BoolToFilterBgConverter}}"
                              BorderBrush="{Binding Color}"
                              BorderThickness="2"
                              CornerRadius="16"
                              Padding="14,8"
                              MinWidth="60"
                              MinHeight="36">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                          <Border Width="10" Height="10" CornerRadius="5" Background="{Binding Color}"
                                  IsVisible="{Binding IsSelected}"/>
                          <TextBlock Text="{Binding Name}" FontSize="13"
                                     Foreground="{Binding IsSelected, Converter={StaticResource BoolToFilterFgConverter}}"/>
                        </StackPanel>
                      </Button>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- 대대 필터 (사단 중간관리자) -->
                <ItemsControl ItemsSource="{Binding BattalionFilters}"
                              IsVisible="{Binding IsBattalionFilter}">
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <StackPanel Orientation="Horizontal" Spacing="10"/>
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                  <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:BattalionFilterItem">
                      <Button Command="{Binding $parent[ItemsControl].((vm:CalendarViewModel)DataContext).SelectBattalionFilterCommand}"
                              CommandParameter="{Binding}"
                              Background="{Binding IsSelected, Converter={StaticResource BoolToFilterBgConverter}}"
                              BorderBrush="{Binding Color}"
                              BorderThickness="2"
                              CornerRadius="16"
                              Padding="14,8"
                              MinWidth="60"
                              MinHeight="36">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                          <Border Width="10" Height="10" CornerRadius="5" Background="{Binding Color}"
                                  IsVisible="{Binding IsSelected}"/>
                          <TextBlock Text="{Binding Name}" FontSize="13"
                                     Foreground="{Binding IsSelected, Converter={StaticResource BoolToFilterFgConverter}}"/>
                        </StackPanel>
                      </Button>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
              </Grid>
            </ScrollViewer>
          </Border>

          <!-- 일정 목록 -->
          <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding FilteredSelectedDaySchedules}">
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="vm:CalendarScheduleItem">
                  <Button Command="{Binding $parent[ItemsControl].((vm:CalendarViewModel)DataContext).OpenScheduleDetailCommand}"
                          CommandParameter="{Binding}"
                          Background="Transparent" Padding="0" Margin="0,0,0,10"
                          HorizontalAlignment="Stretch"
                          HorizontalContentAlignment="Stretch">
                    <Border Background="#3c3c3e" CornerRadius="14" Padding="16"
                            BorderBrush="{Binding GroupColor}" BorderThickness="0,0,0,3">
                      <Grid RowDefinitions="Auto,Auto,Auto">
                        <!-- 업체명 + 상태 + 시도/사단 -->
                        <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                          <StackPanel>
                            <TextBlock Text="{Binding CompanyName}" FontSize="15" Foreground="#effdf6"
                                       TextTrimming="CharacterEllipsis"/>
                            <!-- 최종관리자용: 시도/사단명 표시 -->
                            <TextBlock Text="{Binding GroupName}" FontSize="12" Foreground="{Binding GroupColor}"
                                       Margin="0,2,0,0"
                                       IsVisible="{Binding HasGroupName}"/>
                          </StackPanel>
                          <Border Grid.Column="1" Background="{Binding StatusColor}"
                                  CornerRadius="8" Padding="10,5" Margin="10,0,0,0"
                                  VerticalAlignment="Top">
                            <TextBlock Text="{Binding StatusDisplayName}" FontSize="12" Foreground="White"/>
                          </Border>
                        </Grid>

                        <!-- 시간 -->
                        <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="8" Margin="0,10,0,0">
                          <TextBlock Text="&#xe8b5;" FontFamily="{StaticResource MaterialIcons}"
                                     FontSize="16" Foreground="#00a872" VerticalAlignment="Center"/>
                          <TextBlock Text="{Binding TimeDisplay}" FontSize="14" Foreground="#00a872"/>
                        </StackPanel>

                        <!-- 확정 상태 -->
                        <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="8" Margin="0,8,0,0">
                          <TextBlock Text="&#xe876;" FontFamily="{StaticResource MaterialIcons}"
                                     FontSize="14" Foreground="#808080" VerticalAlignment="Center"/>
                          <TextBlock Text="{Binding ConfirmStatusText}" FontSize="13" Foreground="#a0a0a0"/>
                        </StackPanel>
                      </Grid>
                    </Border>
                  </Button>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </ScrollViewer>

          <!-- 안내 텍스트 -->
          <Border Grid.Row="3" Background="#2c2c2e" CornerRadius="10" Padding="12" Margin="0,12,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8">
              <TextBlock Text="&#xe88e;" FontFamily="{StaticResource MaterialIcons}"
                         FontSize="14" Foreground="#6a6a6a" VerticalAlignment="Center"/>
              <TextBlock Text="일정을 탭하여 상세 정보를 확인하세요" FontSize="12" Foreground="#6a6a6a"/>
            </StackPanel>
          </Border>
        </Grid>
      </Border>
    </Border>
  </Grid>
</UserControl>
