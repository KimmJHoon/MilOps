<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:MilOps.ViewModels"
             x:Class="MilOps.Views.ScheduleListView"
             x:DataType="vm:ScheduleListViewModel">

  <Grid Background="#000000">
    <!-- 메인 컨텐츠 -->
    <ScrollViewer HorizontalScrollBarVisibility="Disabled">
      <StackPanel Margin="10" Spacing="10">

        <!-- 역할 탭 (현재 사용자 역할에 따라 하나만 표시) -->
        <Border Background="#1A1A1A" CornerRadius="8" Padding="8">
          <Panel HorizontalAlignment="Center">
            <Border Background="#2196F3" CornerRadius="6" Padding="10,6"
                    IsVisible="{Binding ShowLocalUserTab}">
              <TextBlock Text="지자체담당자" Foreground="White" FontSize="12"/>
            </Border>
            <Border Background="#4CAF50" CornerRadius="6" Padding="10,6"
                    IsVisible="{Binding ShowMilitaryUserTab}">
              <TextBlock Text="대대담당자" Foreground="White" FontSize="12"/>
            </Border>
            <Border Background="#9C27B0" CornerRadius="6" Padding="10,6"
                    IsVisible="{Binding ShowDivisionTab}">
              <TextBlock Text="사단담당자" Foreground="White" FontSize="12"/>
            </Border>
            <Border Background="#FF9800" CornerRadius="6" Padding="10,6"
                    IsVisible="{Binding ShowRegionTab}">
              <TextBlock Text="지자체(도)" Foreground="White" FontSize="12"/>
            </Border>
          </Panel>
        </Border>

        <!-- 현재 사용자 정보 -->
        <Border Background="#1A3A5C" CornerRadius="8" Padding="10">
          <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="5">
            <TextBlock Text="사용자 정보 : " FontSize="13"/>
            <TextBlock Text="{Binding CurrentUserDisplay}" Foreground="White" FontSize="13"
                       TextTrimming="CharacterEllipsis"/>
          </StackPanel>
        </Border>

        <!-- 상태 필터 탭 - 2행으로 배치 -->
        <Border Background="#1A1A1A" CornerRadius="8" Padding="6">
          <StackPanel Spacing="4">
            <!-- 첫번째 행: 전체, 생성됨, 입력됨 -->
            <Grid ColumnDefinitions="*,*,*" HorizontalAlignment="Stretch">
              <Button Grid.Column="0" Command="{Binding SetStatusFilterCommand}" CommandParameter="all"
                      Background="{Binding SelectedStatusFilter, Converter={StaticResource StatusFilterConverter}, ConverterParameter=all}"
                      Padding="6,6" CornerRadius="6" HorizontalAlignment="Stretch" Margin="2,0">
                <StackPanel Orientation="Horizontal" Spacing="3" HorizontalAlignment="Center">
                  <TextBlock Text="전체" Foreground="White" FontSize="12"/>
                  <TextBlock Text="{Binding AllCount}" Foreground="#AAAAAA" FontSize="11"/>
                </StackPanel>
              </Button>
              <Button Grid.Column="1" Command="{Binding SetStatusFilterCommand}" CommandParameter="created"
                      Background="{Binding SelectedStatusFilter, Converter={StaticResource StatusFilterConverter}, ConverterParameter=created}"
                      Padding="6,6" CornerRadius="6" HorizontalAlignment="Stretch" Margin="2,0">
                <StackPanel Orientation="Horizontal" Spacing="3" HorizontalAlignment="Center">
                  <TextBlock Text="생성" Foreground="White" FontSize="12"/>
                  <TextBlock Text="{Binding CreatedCount}" Foreground="#AAAAAA" FontSize="11"/>
                </StackPanel>
              </Button>
              <Button Grid.Column="2" Command="{Binding SetStatusFilterCommand}" CommandParameter="inputted"
                      Background="{Binding SelectedStatusFilter, Converter={StaticResource StatusFilterConverter}, ConverterParameter=inputted}"
                      Padding="6,6" CornerRadius="6" HorizontalAlignment="Stretch" Margin="2,0">
                <StackPanel Orientation="Horizontal" Spacing="3" HorizontalAlignment="Center">
                  <TextBlock Text="입력" Foreground="White" FontSize="12"/>
                  <TextBlock Text="{Binding InputtedCount}" Foreground="#AAAAAA" FontSize="11"/>
                </StackPanel>
              </Button>
            </Grid>
            <!-- 두번째 행: 예약됨, 확정됨 -->
            <Grid ColumnDefinitions="*,*" HorizontalAlignment="Stretch">
              <Button Grid.Column="0" Command="{Binding SetStatusFilterCommand}" CommandParameter="reserved"
                      Background="{Binding SelectedStatusFilter, Converter={StaticResource StatusFilterConverter}, ConverterParameter=reserved}"
                      Padding="6,6" CornerRadius="6" HorizontalAlignment="Stretch" Margin="2,0">
                <StackPanel Orientation="Horizontal" Spacing="3" HorizontalAlignment="Center">
                  <TextBlock Text="예약" Foreground="White" FontSize="12"/>
                  <TextBlock Text="{Binding ReservedCount}" Foreground="#AAAAAA" FontSize="11"/>
                </StackPanel>
              </Button>
              <Button Grid.Column="1" Command="{Binding SetStatusFilterCommand}" CommandParameter="confirmed"
                      Background="{Binding SelectedStatusFilter, Converter={StaticResource StatusFilterConverter}, ConverterParameter=confirmed}"
                      Padding="6,6" CornerRadius="6" HorizontalAlignment="Stretch" Margin="2,0">
                <StackPanel Orientation="Horizontal" Spacing="3" HorizontalAlignment="Center">
                  <TextBlock Text="확정" Foreground="White" FontSize="12"/>
                  <TextBlock Text="{Binding ConfirmedCount}" Foreground="#AAAAAA" FontSize="11"/>
                </StackPanel>
              </Button>
            </Grid>
          </StackPanel>
        </Border>

        <!-- 안내 메시지 -->
        <Border Background="#2E7D32" CornerRadius="8" Padding="10"
                IsVisible="{Binding ShowGuideMessage}" HorizontalAlignment="Stretch">
          <TextBlock Text="{Binding GuideMessage}" Foreground="White" FontSize="12"
                     TextWrapping="Wrap" TextAlignment="Center" HorizontalAlignment="Stretch"/>
        </Border>

        <!-- 액션 버튼 영역 -->
        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding ShowCompanyRegisterButton}">
          <TextBlock Text="관할 지역 일정 확인" Foreground="#888888" FontSize="12"
                     VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
          <Button Grid.Column="1" Command="{Binding OpenCompanyRegisterCommand}"
                  Background="#FF9800" Padding="12,8" CornerRadius="6">
            <TextBlock Text="+ 업체등록" Foreground="White" FontSize="13"/>
          </Button>
        </Grid>

        <Grid ColumnDefinitions="*,Auto" IsVisible="{Binding ShowScheduleCreateButton}">
          <TextBlock Text="일정 생성 및 관리" Foreground="#888888" FontSize="12"
                     VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
          <Button Grid.Column="1" Command="{Binding OpenScheduleCreateCommand}"
                  Background="#9C27B0" Padding="12,8" CornerRadius="6">
            <TextBlock Text="+ 일정생성" Foreground="White" FontSize="13"/>
          </Button>
        </Grid>

        <!-- 로딩 표시 -->
        <TextBlock Text="로딩중..."
                   IsVisible="{Binding IsLoading}"
                   Foreground="#888888"
                   HorizontalAlignment="Center"
                   FontSize="13"/>

        <!-- 빈 목록 메시지 -->
        <Border Background="#1A1A1A" CornerRadius="8" Padding="20"
                IsVisible="{Binding ShowEmptyMessage}">
          <TextBlock Text="{Binding EmptyMessage}"
                     Foreground="#888888"
                     HorizontalAlignment="Center"
                     FontSize="13"
                     TextWrapping="Wrap"/>
        </Border>

        <!-- 일정 목록 -->
        <ItemsControl ItemsSource="{Binding Schedules}">
          <ItemsControl.ItemTemplate>
            <DataTemplate DataType="vm:ScheduleListItem">
              <!-- 전체 컨테이너 Grid -->
              <Grid Margin="0,4">
                <!-- 메인 버튼 (일정 상세로 이동) -->
                <Button Command="{Binding $parent[ItemsControl].((vm:ScheduleListViewModel)DataContext).SelectScheduleCommand}"
                        CommandParameter="{Binding}"
                        Background="Transparent"
                        Padding="0"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Stretch">
                  <Border Background="#1A1A1A" CornerRadius="8" Padding="12">
                    <Grid RowDefinitions="Auto,Auto,Auto,Auto">

                      <!-- Row 0: 업체명 + 상태 배지 -->
                      <Grid Grid.Row="0" ColumnDefinitions="*,Auto">
                        <TextBlock Grid.Column="0" Text="{Binding CompanyName}"
                                   FontSize="14" Foreground="White"
                                   TextTrimming="CharacterEllipsis"/>
                        <Border Grid.Column="1" Background="{Binding StatusColor}"
                                CornerRadius="4" Padding="8,3" Margin="8,0,0,0">
                          <TextBlock Text="{Binding StatusDisplay}" FontSize="11" Foreground="White"/>
                        </Border>
                      </Grid>

                      <!-- Row 1: 대대 정보 -->
                      <TextBlock Grid.Row="1" Text="{Binding BattalionName}"
                                 FontSize="12" Foreground="#AAAAAA" Margin="0,4,0,0"
                                 TextTrimming="CharacterEllipsis"/>

                      <!-- Row 2: 예약 시간 (예약됨/확정됨 상태에서만) -->
                      <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="6" Margin="0,6,0,0"
                                  IsVisible="{Binding HasReservedTime}">
                        <TextBlock Text="&#xe935;" FontFamily="{StaticResource MaterialIcons}" FontSize="14"/>
                        <TextBlock Text="{Binding ReservedTimeDisplay}"
                                   FontSize="12" Foreground="#2196F3"/>
                      </StackPanel>

                      <!-- Row 3: 액션 영역 -->
                      <Grid Grid.Row="3" ColumnDefinitions="*,Auto" Margin="0,8,0,0">

                        <!-- 미확정 정보 -->
                        <TextBlock Text="{Binding UnconfirmedInfo}"
                                   FontSize="11" Foreground="#FF9800"
                                   TextTrimming="CharacterEllipsis"
                                   IsVisible="{Binding UnconfirmedInfo, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

                        <!-- 액션 텍스트 (삭제 불가능한 경우) -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4"
                                    IsVisible="{Binding !CanDelete}">
                          <TextBlock Text="{Binding ActionIcon}" Foreground="#2196F3" FontSize="12"/>
                          <TextBlock Text="{Binding ActionText}" Foreground="#2196F3" FontSize="12"/>
                        </StackPanel>

                        <!-- 삭제하기 텍스트 (삭제 가능한 경우) -->
                        <Button Grid.Column="1"
                                Command="{Binding $parent[ItemsControl].((vm:ScheduleListViewModel)DataContext).DeleteScheduleCommand}"
                                CommandParameter="{Binding}"
                                Background="Transparent"
                                Padding="0"
                                IsVisible="{Binding CanDelete}">
                          <StackPanel Orientation="Horizontal" Spacing="4">
                            <TextBlock Text="→" Foreground="#F44336" FontSize="12"/>
                            <TextBlock Text="삭제하기" Foreground="#F44336" FontSize="12"/>
                          </StackPanel>
                        </Button>
                      </Grid>

                    </Grid>
                  </Border>
                </Button>
              </Grid>
            </DataTemplate>
          </ItemsControl.ItemTemplate>
        </ItemsControl>

      </StackPanel>
    </ScrollViewer>

    <!-- 삭제 확인 모달 오버레이 -->
    <Grid IsVisible="{Binding ShowDeleteModal}">
      <!-- 배경 오버레이 -->
      <Border Background="#000000" Opacity="0.7"/>

      <!-- 모달 다이얼로그 -->
      <Border Background="#1A1A1A" CornerRadius="16"
              Padding="24" Margin="32"
              VerticalAlignment="Center"
              HorizontalAlignment="Stretch">
        <StackPanel Spacing="20">
          <!-- 제목 -->
          <TextBlock Text="일정을 삭제하시겠습니까?"
                     FontSize="18" Foreground="White"
                     HorizontalAlignment="Center"/>

          <!-- 일정 정보 -->
          <Border Background="#252525" CornerRadius="10" Padding="16">
            <StackPanel Spacing="12">
              <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto">
                <TextBlock Grid.Row="0" Grid.Column="0" Text="업체:"
                           FontSize="14" Foreground="#888888" Margin="0,0,16,8"/>
                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding DeleteModalCompanyName}"
                           FontSize="14" Foreground="White" Margin="0,0,0,8"/>

                <TextBlock Grid.Row="1" Grid.Column="0" Text="대대:"
                           FontSize="14" Foreground="#888888" Margin="0,0,16,0"/>
                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding DeleteModalBattalionName}"
                           FontSize="14" Foreground="White"/>
              </Grid>
            </StackPanel>
          </Border>

          <!-- 경고 메시지 -->
          <Border Background="#5F2A2A" CornerRadius="8" Padding="12">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8">
              <TextBlock Text="&#x26A0;" FontSize="14"/>
              <TextBlock Text="삭제된 일정은 복구할 수 없습니다"
                         FontSize="13" Foreground="#FF8888"/>
            </StackPanel>
          </Border>

          <!-- 버튼 -->
          <Grid ColumnDefinitions="*,*" Margin="0,8,0,0">
            <Button Grid.Column="0" Command="{Binding CancelDeleteCommand}"
                    Background="#333333" CornerRadius="8"
                    HorizontalAlignment="Stretch" Padding="16"
                    HorizontalContentAlignment="Center"
                    Margin="0,0,8,0">
              <TextBlock Text="취소" FontSize="15" Foreground="White"/>
            </Button>
            <Button Grid.Column="1" Command="{Binding ConfirmDeleteCommand}"
                    Background="#F44336" CornerRadius="8"
                    HorizontalAlignment="Stretch" Padding="16"
                    HorizontalContentAlignment="Center"
                    Margin="8,0,0,0">
              <TextBlock Text="삭제" FontSize="15" Foreground="White"/>
            </Button>
          </Grid>
        </StackPanel>
      </Border>
    </Grid>
  </Grid>
</UserControl>
